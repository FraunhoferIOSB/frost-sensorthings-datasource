{"version":3,"sources":["../src/query_ctrl.js"],"names":["QueryCtrl","appEvents","AlertSrv","jp","GenericDatasourceQueryCtrl","$scope","$injector","alertSrv","scope","notificationShowTime","target","panelType","ctrl","panel","type","selectedDatastreamId","selectedDatastreamName","selectedDatastreamDirty","selectedDatastreamObservationType","allDataSources","selectedSensorId","selectedSensorName","selectedSensorDirty","allSensors","selectedThingId","selectedThingName","selectedThingDirty","allThings","selectedLocationId","selectedLocationName","selectedLocationDirty","allLocations","panelCtrl","events","on","onDataReceived","bind","onDataError","jsonQuery","set","dataList","lastQueryError","err","handleQueryCtrlError","query","refId","error","data","message","targetTypes","push","rawQuery","self","datasource","metricFindQuery","then","result","catch","sensor","_","find","text","resetDataSource","targetUrl","value","getFormatedId","id","Number","isInteger","isNaN","datastream","toLowerCase","isOmObservationType","refresh","console","log","isEmpty","includes","thing","location","templateUrl"],"mappings":"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","file":"query_ctrl.js","sourcesContent":["import {QueryCtrl} from 'app/plugins/sdk';\nimport './css/query-editor.css!';\n\nimport { appEvents} from 'app/core/core';\nimport { AlertSrv} from 'app/core/core';\n\nimport * as jp from './libs/jsonpath.js';\n\n\nexport class GenericDatasourceQueryCtrl extends QueryCtrl {\n\n    constructor($scope, $injector,alertSrv)  {\n\n        super($scope, $injector);\n\n        this.scope = $scope;\n        this.alertSrv = alertSrv;\n        this.notificationShowTime = 5000;\n\n        this.target.panelType = this.scope.ctrl.panel.type;\n\n        this.target.type = this.target.type || 'Sensors';\n\n        // datasource init start\n        this.target.selectedDatastreamId = this.target.selectedDatastreamId || 0;\n        this.target.selectedDatastreamName = this.target.selectedDatastreamName || 'select a datastream';\n        this.target.selectedDatastreamDirty = this.target.selectedDatastreamDirty || false;\n        this.target.selectedDatastreamObservationType = this.target.selectedDatastreamObservationType || '';\n        this.allDataSources  = {};\n        // datasource init end\n\n        // sensor init start\n        this.target.selectedSensorId = this.target.selectedSensorId || 0;\n        this.target.selectedSensorName = this.target.selectedSensorName || 'select a sensor';\n        this.target.selectedSensorDirty = this.target.selectedSensorDirty || false;\n        this.allSensors  = {};\n        // sensor init end\n\n        // thing init start\n        this.target.selectedThingId = this.target.selectedThingId || 0;\n        this.target.selectedThingName = this.target.selectedThingName || 'select a thing';\n        this.target.selectedThingDirty = this.target.selectedThingDirty || false;\n        this.allThings  = {};\n        // thing init end\n\n\n        // Location init start\n        this.target.selectedLocationId = this.target.selectedLocationId || 0;\n        this.target.selectedLocationName = this.target.selectedLocationName || 'select a location';\n        this.target.selectedLocationDirty = this.target.selectedLocationDirty || false;\n        this.allLocations = {};\n        // Location init end\n\n        this.panelCtrl.events.on('data-received', this.onDataReceived.bind(this), $scope);\n        this.panelCtrl.events.on('data-error', this.onDataError.bind(this), $scope);\n\n        this.target.jsonQuery = this.target.jsonQuery || '';\n        // appEvents.emit('alert-success', ['Test notification sent', '']);\n\n        if (this.target.selectedThingDirty) {\n            this.alertSrv.set(\"Thing Not Found\", this.target.selectedThingId + \" is not a valid thing name\", 'error', this.notificationShowTime);\n        }\n\n        if (this.target.selectedSensorDirty) {\n            this.alertSrv.set(\"Sensor Not Found\", this.target.selectedSensorId + \" is not a valid sensor name\", 'error', this.notificationShowTime);\n        }\n\n        if (this.target.selectedDatastreamDirty) {\n            this.alertSrv.set(\"Datastream Not Found\", this.target.selectedDatastreamName + \" is not a valid datastream name\", 'error', this.notificationShowTime);\n        }\n\n        if (this.target.selectedLocationDirty) {\n            this.alertSrv.set(\"Location Not Found\", this.target.selectedLocationId + \" is not a valid location name\", 'error', this.notificationShowTime);\n        }\n\n    }\n\n    onDataReceived(dataList) {\n        this.lastQueryError = null;\n    }\n\n    onDataError(err) {\n        this.handleQueryCtrlError(err);\n    }\n\n    handleQueryCtrlError(err) {\n        if (err.query && err.query.refId && err.query.refId !== this.target.refId) {\n            return;\n        }\n\n        if (err.error && err.error.data && err.error.data.error) {\n            this.lastQueryError = err.error.data.error.message;\n        } else if (err.error && err.error.data) {\n            this.lastQueryError = err.error.data.message;\n        } else if (err.data && err.data.error) {\n            this.lastQueryError = err.data.error.message;\n        } else if (err.data && err.data.message) {\n            this.lastQueryError = err.data.message;\n        } else {\n            this.lastQueryError = err;\n        }\n    }\n\n    getTargetTypes() {\n        let targetTypes = ['Sensors', 'Things'];\n        if (this.target.panelType == 'table') {\n            targetTypes.push('Locations','Historical Locations');\n        }\n        return targetTypes;\n    }\n\n    showControlTypes(){\n        return (this.target.panelType != 'grafana-worldmap-panel');\n    }\n\n    toggleEditorMode() {\n        this.target.rawQuery = !this.target.rawQuery;\n    }\n\n\n    //sensor starts\n    showSensors(){\n        return this.target.type == 'Sensors' &&\n                (this.target.panelType != 'grafana-worldmap-panel');\n    }\n\n    getSensors(query) {\n        let self = this;\n        return this.datasource.metricFindQuery((query || ''),\"/Sensors\",'sensor').then((result)=>{\n            self.allSensors = result;\n            return result;\n        }).catch(this.handleQueryCtrlError.bind(this));\n    }\n\n    onSensorChange(query,selectedSensorId) {\n        let sensor = _.find(this.allSensors, { 'value' : this.target.selectedSensorId });\n\n        if(sensor) {\n            this.target.selectedSensorName = sensor.text;\n            this.target.selectedSensorDirty = false;\n        } else {\n            this.target.selectedSensorDirty = true;\n            this.target.selectedDatastreamId = 0;\n            this.alertSrv.set(\"Sensor Not Found\", this.target.selectedSensorId + \" is not a valid sensor name\", 'error', this.notificationShowTime);\n        }\n        this.resetDataSource();\n    }\n    //sensor ends\n\n    //datastream starts\n    showDatastreams(){\n        return (this.target.selectedSensorId!=0 || this.target.selectedThingId!=0) &&\n                (this.target.type == \"Sensors\" || this.target.type == \"Things\") &&\n                (this.target.panelType != 'grafana-worldmap-panel');\n    }\n// TODO: show errors below each query editor\n    getDataStreams(query) {\n        let self = this;\n        let targetUrl = \"\";\n        if (this.target.selectedThingDirty || this.target.selectedSensorDirty) {\n            return [{\n                text: \"select a datastream\",\n                value: 0\n            }];\n        }\n        if (this.target.type == 'Sensors') {\n            targetUrl = \"/Sensors(\"+this.getFormatedId(this.target.selectedSensorId)+\")/Datastreams\";\n        } else {\n            targetUrl = \"/Things(\"+this.getFormatedId(this.target.selectedThingId)+\")/Datastreams\";\n        }\n        return this.datasource.metricFindQuery((query || ''),targetUrl,'datastream').then((result)=>{\n            self.allDataSources = result;\n            return result;\n        }).catch(this.handleQueryCtrlError.bind(this));\n    }\n\n    getFormatedId(id) {\n        return (Number.isInteger(id) || !isNaN(id)) ? id : \"'\"+id+\"'\";\n    }\n\n    onDataStreamChange(query) {\n        if (this.target.selectedThingDirty || this.target.selectedSensorDirty) {\n            return;\n        }\n\n        let datastream = _.find(this.allDataSources, { 'value' : this.target.selectedDatastreamId });\n\n        if(datastream) {\n            this.target.selectedDatastreamName = datastream.text;\n            this.target.selectedDatastreamObservationType = datastream.type.toLowerCase();\n            this.target.selectedDatastreamDirty = false;\n        } else {\n            this.target.selectedDatastreamDirty = true;\n            this.target.selectedDatastreamName = this.target.selectedDatastreamId;\n            this.target.selectedDatastreamObservationType = '';\n            this.alertSrv.set(\"Datastream Not Found\", this.target.selectedDatastreamName + \" is not a valid datastream name\", 'error', this.notificationShowTime);\n        }\n\n        if (this.isOmObservationType(this.target.selectedDatastreamObservationType)) {\n\n        } else {\n            this.panelCtrl.refresh();\n        }\n    }\n\n    onJsonQueryChange() {\n        console.log(this.target.jsonQuery);\n        this.panelCtrl.refresh();\n    }\n\n    isOmObservationType(type) {\n        if (_.isEmpty(type)) {\n            return false;\n        }\n\n        if (!type.includes('om_observation')) {\n            return false;\n        }\n\n        return true;\n    }\n\n    resetDataSource(){\n        this.target.selectedDatastreamId = 0;\n        this.target.selectedDatastreamName = \"select a datastream\";\n        this.panelCtrl.refresh();\n    }\n    //datastream ends\n\n    typeChanged(type) {\n        this.target.selectedSensorId = 0;\n        this.target.selectedThingId = 0;\n        this.resetDataSource();\n    }\n\n    //thing starts\n    showThings(){\n        return this.target.type == 'Things' || this.target.type == 'Historical Locations' || (this.target.panelType == 'grafana-worldmap-panel');\n    }\n\n    getThings(query) {\n        let self = this;\n        return this.datasource.metricFindQuery((query || ''),\"/Things\",'thing').then((result)=>{\n            self.allThings = result;\n            return result;\n        }).catch(this.handleQueryCtrlError.bind(this));\n    }\n\n    onThingChange(query) {\n\n        let thing = _.find(this.allThings, { 'value' : this.target.selectedThingId });\n        if(thing) {\n            this.target.selectedThingName = thing.text;\n            this.target.selectedThingDirty = false;\n        } else {\n            this.target.selectedThingDirty = true;\n            this.target.selectedDatastreamId = 0;\n            this.alertSrv.set(\"Thing Not Found\", this.target.selectedThingId + \" is not a valid thing name\", 'error', this.notificationShowTime);\n        }\n        this.resetDataSource();\n    }\n    //thing ends\n\n    //location starts\n    showLocations(){\n        return this.target.type == 'Locations';\n    }\n\n    getLocations(query) {\n        let self = this;\n        return this.datasource.metricFindQuery((query || ''),\"/Locations\",'location').then((result)=>{\n            self.allLocations = result;\n            return result;\n        }).catch(this.handleQueryCtrlError.bind(this));\n    }\n\n    onLocationChange(query) {\n        // find and store the selected location name to use it as column name (refer datasource.js->transformThings())\n        let location = _.find(this.allLocations, { 'value' : this.target.selectedLocationId });\n\n        if (location) {\n            this.target.selectedLocationName = location.text;\n            this.target.selectedLocationDirty = false;\n        } else {\n            this.target.selectedLocationDirty = true;\n            this.alertSrv.set(\"Location Not Found\", this.target.selectedLocationId + \" is not a valid location name\", 'error', this.notificationShowTime);\n        }\n\n        this.panelCtrl.refresh();\n    }\n    //location ends\n\n}\n\nGenericDatasourceQueryCtrl.templateUrl = 'partials/query.editor.html';\n"]}
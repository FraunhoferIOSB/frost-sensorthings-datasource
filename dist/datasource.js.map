{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","JSONPath","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","alertSrv","contextSrv","dashboardSrv","type","url","name","q","withCredentials","headers","notificationShowTime","topCount","basicAuth","length","options","key","from","range","utc","format","to","id","Number","isInteger","isNaN","targets","filter","target","hide","allTargetResults","data","testPromises","map","self","subUrl","thisTargetResult","selectedDatastreamName","toString","selectedDatastreamDirty","selectedLimit","limit","selectedLocationId","timeFilter","getTimeFilter","getFormatedId","selectedThingOption","selectedThingId","selectedDatastreamId","console","log","transformedResults","hasNextLink","fullUrl","response","doRequest","method","has","split","concat","transformThings","value","transformDataSource","transformLocations","datapoints","Promise","all","then","values","isEmpty","includes","status","message","title","query","placeholder","transformedMetrics","text","selectParam","result","transformMetrics","datasourceRequest","error","Array","isArray","Math","min","table","columnMap","columns","meta","refId","rows","push","i","time","Locations","location","coordinates","geometry","isOmObservationType","selectedDatastreamObservationType","jsonQuery","index","json","path","panelType","JSON","stringify","parseInt","phenomenonTime","datapoint","Thing","metrics","forEach","metric"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\n\nimport {JSONPath} from './external/jsonpath.js'; // copied with grunt\nexport class GenericDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv, alertSrv, contextSrv, dashboardSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.headers = { 'Content-Type': 'application/json' };\n    this.alertSrv = alertSrv;\n    this.contextSrv = contextSrv;\n    this.dashboardSrv = dashboardSrv;\n    this.notificationShowTime = 5000;\n    this.topCount = 1000;\n\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n  }\n\n  getTimeFilter(options, key) {\n    let from = options.range.from.utc().format('YYYY-MM-DDTHH:mm:ss.SSS') + 'Z';\n    let to = options.range.to.utc().format('YYYY-MM-DDTHH:mm:ss.SSS') + 'Z';\n    return key + ' gt ' + from + ' and ' + key + ' lt ' + to;\n  }\n\n  getFormatedId(id) {\n    return (Number.isInteger(id) || !isNaN(id)) ? id : '\"' + id + '\"';\n  }\n\n  async query(options) {\n    options.targets = _.filter(options.targets, target => target.hide !== true);\n\n    let allTargetResults = { data: [] };\n\n    let testPromises = options.targets.map(async target => {\n      let self = this;\n      let subUrl = '';\n      let thisTargetResult = {\n        'target' : target.selectedDatastreamName.toString(),\n        'datapoints' : [],\n      };\n\n      if (target.selectedDatastreamDirty) {\n        return thisTargetResult;\n      }\n\n      if(typeof(target.selectedLimit) == \"undefined\") {\n        target.selectedLimit = 1;\n      }\n      let limit = 0;\n\n      if (target.type === \"Locations\") {\n        if (target.selectedLocationId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"time\");\n        subUrl = `/Locations(${this.getFormatedId(target.selectedLocationId)})/HistoricalLocations?$filter=${timeFilter}&$expand=Things($select=name)&$select=time&$top=${this.topCount}`;\n      } else if(target.type === \"Things\" && target.selectedThingOption === \"Historical Locations\") {\n        if (target.selectedThingId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"time\");\n        subUrl = `/Things(${this.getFormatedId(target.selectedThingId)})/HistoricalLocations?$filter=${timeFilter}&$expand=Locations($select=name)&$select=time&$top=${target.selectedLimit === 0 ? this.topCount : target.selectedLimit}`;\n        limit = target.selectedLimit;\n      } else if(target.type === \"Things\" && target.selectedThingOption === \"Historical Locations with Coordinates\") {\n        if (target.selectedThingId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"time\");\n        subUrl = `/Things(${this.getFormatedId(target.selectedThingId)})/HistoricalLocations?$filter=${timeFilter}&$expand=Locations($select=name,location)&$select=time&$top=${target.selectedLimit === 0 ? this.topCount : target.selectedLimit}`;\n        limit = target.selectedLimit;\n      } else {\n        if (target.selectedDatastreamId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"phenomenonTime\");\n        subUrl = `/Datastreams(${this.getFormatedId(target.selectedDatastreamId)})/Observations?$filter=${timeFilter}&$select=phenomenonTime,result&$orderby=phenomenonTime desc&$top=${this.topCount}`;\n      }\n      console.log(\"subUrl:\", subUrl);\n\n      let transformedResults = [];\n      let hasNextLink = true;\n      let fullUrl = this.url + subUrl;\n\n      while(hasNextLink) {\n        if(transformedResults.length >= limit && limit !== 0) {\n          break;\n        }\n\n        let response = await this.doRequest({\n          url: fullUrl,\n          method: 'GET'\n        });\n\n        hasNextLink = _.has(response.data, \"@iot.nextLink\");\n        if (hasNextLink) {\n          subUrl = subUrl.split('?')[0];\n          fullUrl = this.url + subUrl + \"?\" + response.data[\"@iot.nextLink\"].split('?')[1];\n        }\n\n        if (target.type === \"Locations\") {\n          transformedResults = transformedResults.concat(self.transformThings(target, response.data.value));\n        } else if (target.type === \"Things\" && (target.selectedThingOption === \"Historical Locations\" || target.selectedThingOption === \"Historical Locations with Coordinates\")) {\n          transformedResults = transformedResults.concat(response.data.value);\n        } else {\n          transformedResults = transformedResults.concat(self.transformDataSource(target,response.data.value));\n        }\n      }\n\n      if(target.type === \"Things\" && (target.selectedThingOption === \"Historical Locations\" || target.selectedThingOption === \"Historical Locations with Coordinates\")) {\n        return self.transformLocations(target, transformedResults, limit);\n      }\n\n      thisTargetResult.datapoints = transformedResults;\n\n      return thisTargetResult;\n    });\n\n    return Promise.all(testPromises).then(function (values) {\n      allTargetResults.data = values;\n      return allTargetResults;\n    });\n  }\n\n  isOmObservationType(type) {\n    if (_.isEmpty(type)) {\n      return false;\n    }\n\n    if (!type.includes('om_observation')) {\n      return false;\n    }\n\n    return true;\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url,\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: 'success', message: 'Data source is working', title: 'Success' };\n      }\n    });\n  }\n\n  async metricFindQuery(query, subUrl, type) {\n    let placeholder = 'select a sensor';\n\n    if (type === 'thing') {\n      placeholder = 'select a thing';\n    } else if (type === 'datastream') {\n      placeholder = 'select a datastream';\n    } else if (type === 'location') {\n      placeholder = 'select a location';\n    }\n\n    let transformedMetrics = [{\n      text: placeholder,\n      value: 0,\n      type: ''\n    }];\n\n    let hasNextLink = true;\n    let selectParam = (type === 'datastream') ? '$select=name,id,observationType' : '$select=name,id';\n    let fullUrl = this.url + subUrl + `?$top=${this.topCount}&${selectParam}`;\n\n    while (hasNextLink) {\n      let result = await this.doRequest({\n        url: fullUrl,\n        method: 'GET',\n      });\n      hasNextLink = _.has(result.data, '@iot.nextLink');\n      if (hasNextLink) {\n        fullUrl = this.url + subUrl + '?' + result.data['@iot.nextLink'].split('?')[1];\n      }\n      transformedMetrics = transformedMetrics.concat(this.transformMetrics(result.data.value, type));\n    }\n\n    return transformedMetrics;\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  //#region Transforn results\n  transformLocations(target, value, limit) {\n    if (!value) {\n      console.error('Invalid location data for Thing ' + target.selectedThingId);\n      return [];\n    }\n\n    if (Array.isArray(value)) {\n      if (value.length === 0) {\n        console.log('No location for Thing ' + target.selectedThingId);\n        return [];\n      }\n    }\n\n    if(limit == 0) {\n      limit = value.length;\n    }\n\n    limit = Math.min(limit, value.length);\n\n    let table = {\n      columnMap: {},\n      columns: [\n        {text: \"Time\", type: \"time\"}\n      ],\n      meta: {},\n      refId: target.refId,\n      rows: [],\n      type: \"table\"\n    };\n\n    if(target.selectedThingOption === \"Historical Locations\") {\n      table.columns.push({text: \"Location\"});\n    } else if(target.selectedThingOption === \"Historical Locations with Coordinates\") {\n      table.columns.push({text: \"longitude\"});\n      table.columns.push({text: \"latitude\"});\n      table.columns.push({text: \"metric\"});\n      table.columns.push({text: \"Location\"});\n    }\n\n    for(let i = 0; i < limit; i++) {\n      let time = value[i].time;\n      if(target.selectedThingOption === \"Historical Locations\") {\n        table.rows.push([time, value[i].Locations[0].name]);\n      } else if(target.selectedThingOption === \"Historical Locations with Coordinates\") {\n        let location = value[i].Locations[0].location;\n        let coordinates;\n        if (location.type === 'Feature' && location.geometry.type === 'Point') {\n          coordinates = location.geometry.coordinates;\n        } else if (location.type === 'Point') {\n          coordinates = location.coordinates;\n        } else {\n          console.error('Unsupported location type for Thing ' + target.selectedThingId + '. Expected GeoJSON Feature.Point or Point.');\n          return [];\n        }\n        table.rows.push([time, coordinates[0], coordinates[1], target.selectedThingId, value[i].Locations[0].name]);\n      }\n    }\n\n    return table;\n  }\n\n  transformDataSource(target, values) {\n    let self = this;\n\n    if (self.isOmObservationType(target.selectedDatastreamObservationType) && _.isEmpty(target.jsonQuery)) {\n      return [];\n    }\n\n    let datapoints = _.map(values, function (value, index) {\n      if (self.isOmObservationType(target.selectedDatastreamObservationType)) {\n        var result = new JSONPath({ json: value.result, path: target.jsonQuery });\n\n        if (target.panelType === 'table' || target.panelType === 'singlestat') {\n          result = (typeof result[0] === 'object') ? JSON.stringify(result[0]) : result[0];\n          return [result, parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        } else {\n          return [result[0], parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        }\n      } else {\n        if (target.panelType === 'table') {\n          return [_.isEmpty(value.result.toString()) ? '-' : value.result, parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        } else {\n          return [value.result, parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        }\n      }\n    });\n\n    datapoints = _.filter(datapoints, function (datapoint) {\n      return (typeof datapoint[0] === 'string' || typeof datapoint[0] === 'number' || (Number(datapoint[0]) === datapoint[0] && datapoint[0] % 1 !== 0));\n    });\n\n    return datapoints;\n  }\n\n  transformThings(target, values) {\n    return _.map(values, value => {\n      return [_.isEmpty(value.Thing.name) ? '-' : value.Thing.name, parseInt(moment(value.time, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n    });\n  }\n\n  transformMetrics(metrics, type) {\n    let transformedMetrics = [];\n\n    _.forEach(metrics, (metric, index) => {\n      transformedMetrics.push({\n        text: metric.name + ' ( ' + metric['@iot.id'] + ' )',\n        value: metric['@iot.id'],\n        type: metric['observationType']\n      });\n    });\n\n    return transformedMetrics;\n  }\n  //#endregion\n}"]}
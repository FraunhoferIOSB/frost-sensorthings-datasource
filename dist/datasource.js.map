{"version":3,"sources":["../src/datasource.js"],"names":["_","moment","JSONPath","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","alertSrv","contextSrv","dashboardSrv","type","url","name","q","withCredentials","headers","notificationShowTime","topCount","basicAuth","length","options","key","from","range","utc","format","to","id","Number","isInteger","isNaN","targets","filter","target","hide","allTargetResults","data","testPromises","map","self","subUrl","thisTargetResult","selectedDatastreamName","toString","selectedDatastreamDirty","selectedLimit","limit","selectedLocationId","timeFilter","getTimeFilter","getFormatedId","selectedThingOption","selectedThingId","selectedDatastreamId","console","log","transformedResults","hasNextLink","fullUrl","response","doRequest","method","has","split","concat","transformThings","value","transformLocations","transformLocationsCoordinates","transformDataSource","datapoints","Promise","all","then","values","error","Array","isArray","locationName","Locations","location","coordinates","geometry","metricColumn","columnMap","columns","text","meta","refId","rows","time","selectedThingName","isOmObservationType","selectedDatastreamObservationType","isEmpty","jsonQuery","index","result","json","path","panelType","JSON","stringify","parseInt","phenomenonTime","datapoint","includes","Thing","forEach","push","status","message","title","query","placeholder","transformedMetrics","selectParam","transformMetrics","metrics","metric","datasourceRequest"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from 'lodash';\nimport moment from 'moment';\n\nimport {JSONPath} from './external/jsonpath.js'; // copied with grunt\nexport class GenericDatasource {\n  constructor(instanceSettings, $q, backendSrv, templateSrv, alertSrv, contextSrv, dashboardSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.headers = { 'Content-Type': 'application/json' };\n    this.alertSrv = alertSrv;\n    this.contextSrv = contextSrv;\n    this.dashboardSrv = dashboardSrv;\n    this.notificationShowTime = 5000;\n    this.topCount = 1000;\n\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n  }\n\n  getTimeFilter(options, key) {\n    let from = options.range.from.utc().format('YYYY-MM-DDTHH:mm:ss.SSS') + 'Z';\n    let to = options.range.to.utc().format('YYYY-MM-DDTHH:mm:ss.SSS') + 'Z';\n    return key + ' gt ' + from + ' and ' + key + ' lt ' + to;\n  }\n\n  getFormatedId(id) {\n    return (Number.isInteger(id) || !isNaN(id)) ? id : '\"' + id + '\"';\n  }\n\n  async query(options) {\n    options.targets = _.filter(options.targets, target => target.hide !== true);\n\n    let allTargetResults = { data: [] };\n\n    let testPromises = options.targets.map(async target => {\n      let self = this;\n      let subUrl = '';\n      let thisTargetResult = {\n        'target' : target.selectedDatastreamName.toString(),\n        'datapoints' : [],\n      };\n\n      if (target.selectedDatastreamDirty) {\n        return thisTargetResult;\n      }\n\n      if(typeof(target.selectedLimit) == \"undefined\") {\n        target.selectedLimit = 1;\n      }\n      let limit = 0;\n\n      if (target.type === \"Locations\") {\n        if (target.selectedLocationId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"time\");\n        subUrl = `/Locations(${this.getFormatedId(target.selectedLocationId)})/HistoricalLocations?$filter=${timeFilter}&$expand=Things($select=name)&$select=time&$top=${this.topCount}`;\n      } else if(target.type === \"Things\" && target.selectedThingOption === \"Historical Locations\") {\n        if (target.selectedThingId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"time\");\n        subUrl = `/Things(${this.getFormatedId(target.selectedThingId)})/HistoricalLocations?$filter=${timeFilter}&$expand=Locations($select=name)&$select=time&$top=${target.selectedLimit === 0 ? this.topCount : target.selectedLimit}`;\n        limit = target.selectedLimit;\n      } else if(target.type === \"Things\" && target.selectedThingOption === \"Historical Locations with Coordinates\") {\n        if (target.selectedThingId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"time\");\n        subUrl = `/Things(${this.getFormatedId(target.selectedThingId)})/HistoricalLocations?$filter=${timeFilter}&$expand=Locations($select=name,location)&$select=time&$top=${target.selectedLimit === 0 ? this.topCount : target.selectedLimit}`;\n        limit = target.selectedLimit;\n      } else {\n        if (target.selectedDatastreamId == 0) {\n          return thisTargetResult;\n        }\n        let timeFilter = this.getTimeFilter(options,\"phenomenonTime\");\n        subUrl = `/Datastreams(${this.getFormatedId(target.selectedDatastreamId)})/Observations?$filter=${timeFilter}&$select=phenomenonTime,result&$orderby=phenomenonTime desc&$top=${this.topCount}`;\n      }\n      console.log(\"subUrl:\", subUrl);\n\n      let transformedResults = [];\n      let hasNextLink = true;\n      let fullUrl = this.url + subUrl;\n\n      while(hasNextLink) {\n        if(transformedResults.length >= limit && limit !== 0) {\n          break;\n        }\n\n        let response = await this.doRequest({\n          url: fullUrl,\n          method: 'GET'\n        });\n\n        hasNextLink = _.has(response.data, \"@iot.nextLink\");\n        if (hasNextLink) {\n          subUrl = subUrl.split('?')[0];\n          fullUrl = this.url + subUrl + \"?\" + response.data[\"@iot.nextLink\"].split('?')[1];\n        }\n\n        if (target.type === \"Locations\") {\n          transformedResults = transformedResults.concat(self.transformThings(target, response.data.value));\n        } else if (target.type === \"Things\" && target.selectedThingOption === \"Historical Locations\") {\n          transformedResults = transformedResults.concat(self.transformLocations(target,response.data.value));\n        } else if (target.type === \"Things\" && target.selectedThingOption === \"Historical Locations with Coordinates\"){\n          // stop here, as we only need 1 value\n          return self.transformLocationsCoordinates(target, response.data.value);\n        } else {\n          transformedResults = transformedResults.concat(self.transformDataSource(target,response.data.value));\n        }\n      }\n\n      thisTargetResult.datapoints = transformedResults;\n\n      return thisTargetResult;\n    });\n\n    return Promise.all(testPromises).then(function (values) {\n      allTargetResults.data = values;\n      return allTargetResults;\n    });\n  }\n\n  transformLocationsCoordinates(target, value) {\n    if (!value) {\n      console.error('Invalid location data for Thing ' + target.selectedThingId);\n      return [];\n    }\n\n    if (Array.isArray(value)) {\n      if (value.length === 0) {\n        console.log('No location for Thing ' + target.selectedThingId);\n        return [];\n      } else {\n        value = value[0];\n      }\n    }\n\n    let locationName = value.Locations[0].name;\n    let location = value.Locations[0].location;\n    let coordinates;\n    if (location.type === 'Feature' && location.geometry.type === 'Point') {\n      coordinates = location.geometry.coordinates;\n    } else if (location.type === 'Point') {\n      coordinates = location.coordinates;\n    } else {\n      console.error('Unsupported location type for Thing ' + target.selectedThingId + '. Expected GeoJSON Feature.Point or Point.');\n      return [];\n    }\n\n    const metricColumn = 1; // this determines the size and color of the circle\n    return {\n      columnMap: {},\n      columns: [\n        {text: \"Time\", type: \"time\"},\n        {text: \"longitude\"},\n        {text: \"latitude\"},\n        {text: \"metric\"},\n        {text: \"name\"}\n      ],\n      meta: {},\n      refId: target.refId,\n      rows: [\n        [value.time, coordinates[0], coordinates[1], metricColumn, target.selectedThingName]\n      ],\n      type: \"table\"\n    }\n  }\n\n  transformDataSource(target, values) {\n    let self = this;\n\n    if (self.isOmObservationType(target.selectedDatastreamObservationType) && _.isEmpty(target.jsonQuery)) {\n      return [];\n    }\n\n    let datapoints = _.map(values, function (value, index) {\n      if (self.isOmObservationType(target.selectedDatastreamObservationType)) {\n        var result = new JSONPath({ json: value.result, path: target.jsonQuery });\n\n        if (target.panelType === 'table' || target.panelType === 'singlestat') {\n          result = (typeof result[0] === 'object') ? JSON.stringify(result[0]) : result[0];\n          return [result, parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        } else {\n          return [result[0], parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        }\n      } else {\n        if (target.panelType === 'table') {\n          return [_.isEmpty(value.result.toString()) ? '-' : value.result, parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        } else {\n          return [value.result, parseInt(moment(value.phenomenonTime, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n        }\n      }\n    });\n\n    datapoints = _.filter(datapoints, function (datapoint) {\n      return (typeof datapoint[0] === 'string' || typeof datapoint[0] === 'number' || (Number(datapoint[0]) === datapoint[0] && datapoint[0] % 1 !== 0));\n    });\n\n    return datapoints;\n  }\n\n  isOmObservationType(type) {\n    if (_.isEmpty(type)) {\n      return false;\n    }\n\n    if (!type.includes('om_observation')) {\n      return false;\n    }\n\n    return true;\n  }\n\n  transformThings(target, values) {\n    return _.map(values, value => {\n      return [_.isEmpty(value.Thing.name) ? '-' : value.Thing.name, parseInt(moment(value.time, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))];\n    });\n  }\n\n  transformLocations(target, values) {\n    let result = [];\n    _.forEach(values, function (value) {\n      _.forEach(value.Locations, function (location) {\n        result.push([_.isEmpty(location.name) ? '-' : location.name, parseInt(moment(value.time, 'YYYY-MM-DDTHH:mm:ss.SSSZ').format('x'))]);\n      });\n    });\n    return result;\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url,\n      method: 'GET',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: 'success', message: 'Data source is working', title: 'Success' };\n      }\n    });\n  }\n\n  async metricFindQuery(query, subUrl, type) {\n    let placeholder = 'select a sensor';\n\n    if (type === 'thing') {\n      placeholder = 'select a thing';\n    } else if (type === 'datastream') {\n      placeholder = 'select a datastream';\n    } else if (type === 'location') {\n      placeholder = 'select a location';\n    }\n\n    let transformedMetrics = [{\n      text: placeholder,\n      value: 0,\n      type: ''\n    }];\n\n    let hasNextLink = true;\n    let selectParam = (type === 'datastream') ? '$select=name,id,observationType' : '$select=name,id';\n    let fullUrl = this.url + subUrl + `?$top=${this.topCount}&${selectParam}`;\n\n    while (hasNextLink) {\n      let result = await this.doRequest({\n        url: fullUrl,\n        method: 'GET',\n      });\n      hasNextLink = _.has(result.data, '@iot.nextLink');\n      if (hasNextLink) {\n        fullUrl = this.url + subUrl + '?' + result.data['@iot.nextLink'].split('?')[1];\n      }\n      transformedMetrics = transformedMetrics.concat(this.transformMetrics(result.data.value, type));\n    }\n\n    return transformedMetrics;\n  }\n\n  transformMetrics(metrics, type) {\n    let transformedMetrics = [];\n\n    _.forEach(metrics, (metric, index) => {\n      transformedMetrics.push({\n        text: metric.name + ' ( ' + metric['@iot.id'] + ' )',\n        value: metric['@iot.id'],\n        type: metric['observationType']\n      });\n    });\n\n    return transformedMetrics;\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n    return this.backendSrv.datasourceRequest(options);\n  }\n}"]}